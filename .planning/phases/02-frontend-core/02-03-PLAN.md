---
phase: 02-frontend-core
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/components/ChatPanel.tsx
  - frontend/src/components/ChatMessage.tsx
  - frontend/src/components/QuickActions.tsx
  - frontend/src/components/SuggestionButton.tsx
  - frontend/src/lib/api.ts
  - frontend/src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Chat panel shows context about the active question"
    - "User can type a message and send it"
    - "User messages and AI responses display with distinct styling"
    - "Quick action buttons send predefined questions"
    - "Loading indicator shows during AI response"
    - "AI suggestion appears as clickable button that fills the form"
  artifacts:
    - path: "frontend/src/components/ChatPanel.tsx"
      provides: "Main chat container with header, messages, input"
      min_lines: 80
    - path: "frontend/src/components/ChatMessage.tsx"
      provides: "Individual message bubble with role-based styling"
      min_lines: 20
    - path: "frontend/src/components/QuickActions.tsx"
      provides: "Predefined question buttons"
      min_lines: 25
    - path: "frontend/src/components/SuggestionButton.tsx"
      provides: "Clickable AI suggestion that auto-fills form"
      min_lines: 20
    - path: "frontend/src/lib/api.ts"
      provides: "API client for backend chat endpoint"
      exports: ["chatWithAI"]
  key_links:
    - from: "frontend/src/components/ChatPanel.tsx"
      to: "frontend/src/lib/api.ts"
      via: "fetch call to backend"
      pattern: "chatWithAI"
    - from: "frontend/src/components/SuggestionButton.tsx"
      to: "frontend/src/store/formStore.ts"
      via: "setAnswer on click"
      pattern: "setAnswer.*fieldId"
    - from: "frontend/src/lib/api.ts"
      to: "http://localhost:5001/api/chat"
      via: "fetch POST request"
      pattern: "NEXT_PUBLIC_API_URL.*chat"
---

<objective>
Build the chat panel with AI integration: question context header, message list with distinct styling, text input with send, quick action buttons, loading indicator, and suggestion auto-fill functionality.

Purpose: Enable users to get AI-powered help understanding form questions and receive suggestions they can auto-fill.
Output: Fully functional chat panel that communicates with backend API and can auto-fill form fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-api/01-02-SUMMARY.md
@.planning/phases/02-frontend-core/02-01-SUMMARY.md
@frontend/src/types/index.ts
@frontend/src/store/formStore.ts
@frontend/src/data/ontarioWorksForm.ts
@backend/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API client and message components</name>
  <files>
    frontend/src/lib/api.ts
    frontend/src/components/ChatMessage.tsx
    frontend/src/components/QuickActions.tsx
    frontend/src/components/SuggestionButton.tsx
  </files>
  <action>
    1. Create frontend/src/lib/api.ts for backend communication:

    ```typescript
    import { ChatMessage } from '@/types';

    const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5001/api';

    export interface ChatRequest {
      questionId: string;
      originalText: string;
      fieldType: string;
      context?: string;
      conversationHistory: Array<{ role: 'user' | 'assistant'; content: string }>;
      userMessage: string;
      currentAnswers?: Record<string, string | number | boolean>;
    }

    export interface ChatResponse {
      message: string;
      suggestedAnswer?: string;
      confidence?: 'low' | 'medium' | 'high';
    }

    export async function chatWithAI(request: ChatRequest): Promise<ChatResponse> {
      const response = await fetch(`${API_URL}/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(request),
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(error.error || `API error: ${response.status}`);
      }

      return response.json();
    }
    ```

    2. Create frontend/src/components/ChatMessage.tsx:

    ```tsx
    import { ChatMessage as ChatMessageType } from '@/types';
    import { User, Bot } from 'lucide-react';

    interface ChatMessageProps {
      message: ChatMessageType;
    }

    export function ChatMessage({ message }: ChatMessageProps) {
      const isUser = message.role === 'user';

      return (
        <div className={`flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`}>
          <div
            className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${
              isUser ? 'bg-blue-600' : 'bg-gray-200'
            }`}
          >
            {isUser ? (
              <User className="w-4 h-4 text-white" />
            ) : (
              <Bot className="w-4 h-4 text-gray-600" />
            )}
          </div>
          <div
            className={`max-w-[80%] px-4 py-2 rounded-2xl ${
              isUser
                ? 'bg-blue-600 text-white rounded-br-md'
                : 'bg-gray-100 text-gray-800 rounded-bl-md'
            }`}
          >
            <p className="text-sm whitespace-pre-wrap">{message.content}</p>
          </div>
        </div>
      );
    }
    ```

    3. Create frontend/src/components/QuickActions.tsx:

    ```tsx
    import { HelpCircle, FileQuestion, UserCheck } from 'lucide-react';

    interface QuickActionsProps {
      onAction: (message: string) => void;
      disabled?: boolean;
    }

    const QUICK_ACTIONS = [
      {
        label: 'What does this mean?',
        message: 'Can you explain what this question is asking in simple terms?',
        icon: HelpCircle,
      },
      {
        label: 'Give me an example',
        message: 'Can you give me an example of how to answer this question?',
        icon: FileQuestion,
      },
      {
        label: 'Does my situation apply?',
        message: 'How do I know if this question applies to my situation?',
        icon: UserCheck,
      },
    ];

    export function QuickActions({ onAction, disabled }: QuickActionsProps) {
      return (
        <div className="flex flex-wrap gap-2">
          {QUICK_ACTIONS.map((action) => (
            <button
              key={action.label}
              onClick={() => onAction(action.message)}
              disabled={disabled}
              className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <action.icon className="w-3.5 h-3.5" />
              {action.label}
            </button>
          ))}
        </div>
      );
    }
    ```

    4. Create frontend/src/components/SuggestionButton.tsx:

    ```tsx
    import { useFormStore } from '@/store/formStore';
    import { Sparkles, Check } from 'lucide-react';
    import { useState } from 'react';

    interface SuggestionButtonProps {
      fieldId: string;
      suggestion: string;
      confidence?: 'low' | 'medium' | 'high';
    }

    export function SuggestionButton({ fieldId, suggestion, confidence }: SuggestionButtonProps) {
      const setAnswer = useFormStore((state) => state.setAnswer);
      const [applied, setApplied] = useState(false);

      const handleApply = () => {
        setAnswer(fieldId, suggestion);
        setApplied(true);
        setTimeout(() => setApplied(false), 2000);
      };

      const confidenceColors = {
        low: 'border-yellow-300 bg-yellow-50',
        medium: 'border-blue-300 bg-blue-50',
        high: 'border-green-300 bg-green-50',
      };

      const bgColor = confidence ? confidenceColors[confidence] : 'border-blue-300 bg-blue-50';

      return (
        <button
          onClick={handleApply}
          disabled={applied}
          className={`w-full flex items-center gap-2 px-4 py-3 rounded-lg border-2 ${bgColor} hover:opacity-90 transition-all text-left`}
        >
          {applied ? (
            <Check className="w-5 h-5 text-green-600 flex-shrink-0" />
          ) : (
            <Sparkles className="w-5 h-5 text-blue-600 flex-shrink-0" />
          )}
          <div className="flex-1">
            <p className="text-xs text-gray-500 mb-0.5">
              {applied ? 'Applied!' : 'AI Suggestion (click to auto-fill)'}
            </p>
            <p className="text-sm text-gray-800 font-medium">{suggestion}</p>
          </div>
        </button>
      );
    }
    ```
  </action>
  <verify>
    cd frontend && npx tsc --noEmit
  </verify>
  <done>
    API client exports chatWithAI function, message components render with role-based styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChatPanel component</name>
  <files>
    frontend/src/components/ChatPanel.tsx
  </files>
  <action>
    Create frontend/src/components/ChatPanel.tsx with full chat functionality:

    ```tsx
    'use client';

    import { useState, useRef, useEffect } from 'react';
    import { useFormStore } from '@/store/formStore';
    import { ontarioWorksForm } from '@/data/ontarioWorksForm';
    import { ChatMessage } from './ChatMessage';
    import { QuickActions } from './QuickActions';
    import { SuggestionButton } from './SuggestionButton';
    import { chatWithAI } from '@/lib/api';
    import { ChatMessage as ChatMessageType, FormQuestion } from '@/types';
    import { X, Send, MessageCircle } from 'lucide-react';

    export function ChatPanel() {
      const activeQuestionId = useFormStore((state) => state.activeQuestionId);
      const setActiveQuestion = useFormStore((state) => state.setActiveQuestion);
      const conversations = useFormStore((state) => state.conversations);
      const addMessage = useFormStore((state) => state.addMessage);
      const answers = useFormStore((state) => state.answers);

      const [inputValue, setInputValue] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [latestSuggestion, setLatestSuggestion] = useState<{
        answer: string;
        confidence?: 'low' | 'medium' | 'high';
      } | null>(null);

      const messagesEndRef = useRef<HTMLDivElement>(null);
      const inputRef = useRef<HTMLInputElement>(null);

      // Find the active question from form data
      const activeQuestion: FormQuestion | undefined = activeQuestionId
        ? ontarioWorksForm.sections
            .flatMap((s) => s.questions)
            .find((q) => q.id === activeQuestionId)
        : undefined;

      const messages = activeQuestionId ? conversations[activeQuestionId] || [] : [];

      // Scroll to bottom when messages change
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      // Focus input when panel opens
      useEffect(() => {
        if (activeQuestionId) {
          inputRef.current?.focus();
        }
      }, [activeQuestionId]);

      // Clear suggestion when question changes
      useEffect(() => {
        setLatestSuggestion(null);
      }, [activeQuestionId]);

      const sendMessage = async (messageText: string) => {
        if (!messageText.trim() || !activeQuestion || !activeQuestionId) return;

        // Add user message
        const userMessage: ChatMessageType = {
          role: 'user',
          content: messageText.trim(),
          timestamp: Date.now(),
        };
        addMessage(activeQuestionId, userMessage);
        setInputValue('');
        setIsLoading(true);
        setLatestSuggestion(null);

        try {
          // Prepare conversation history for API (exclude timestamps)
          const conversationHistory = [...messages, userMessage].map((m) => ({
            role: m.role,
            content: m.content,
          }));

          const response = await chatWithAI({
            questionId: activeQuestionId,
            originalText: activeQuestion.originalText,
            fieldType: activeQuestion.fieldType,
            context: activeQuestion.context,
            conversationHistory,
            userMessage: messageText.trim(),
            currentAnswers: answers as Record<string, string | number | boolean>,
          });

          // Add assistant message
          const assistantMessage: ChatMessageType = {
            role: 'assistant',
            content: response.message,
            suggestedAnswer: response.suggestedAnswer,
            confidence: response.confidence,
            timestamp: Date.now(),
          };
          addMessage(activeQuestionId, assistantMessage);

          // Update latest suggestion if present
          if (response.suggestedAnswer) {
            setLatestSuggestion({
              answer: response.suggestedAnswer,
              confidence: response.confidence,
            });
          }
        } catch (error) {
          console.error('Chat error:', error);
          const errorMessage: ChatMessageType = {
            role: 'assistant',
            content: 'Sorry, I had trouble connecting. Please check that the backend server is running and try again.',
            timestamp: Date.now(),
          };
          addMessage(activeQuestionId, errorMessage);
        } finally {
          setIsLoading(false);
        }
      };

      const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        sendMessage(inputValue);
      };

      const handleQuickAction = (message: string) => {
        sendMessage(message);
      };

      if (!activeQuestionId || !activeQuestion) {
        return null;
      }

      return (
        <div className="fixed bottom-0 right-0 w-full md:w-[420px] h-[600px] bg-white border-l border-t border-gray-200 shadow-xl flex flex-col z-50">
          {/* Header */}
          <div className="px-4 py-3 border-b border-gray-200 bg-gray-50">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-2">
                <MessageCircle className="w-5 h-5 text-blue-600" />
                <span className="font-medium text-gray-900">Help Assistant</span>
              </div>
              <button
                onClick={() => setActiveQuestion(null)}
                className="p-1 hover:bg-gray-200 rounded-full transition-colors"
                aria-label="Close chat"
              >
                <X className="w-5 h-5 text-gray-500" />
              </button>
            </div>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <p className="text-xs text-blue-600 font-medium mb-1">Current Question</p>
              <p className="text-sm text-gray-800">{activeQuestion.originalText}</p>
            </div>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto px-4 py-4 space-y-4">
            {messages.length === 0 ? (
              <div className="text-center text-gray-500 mt-8">
                <MessageCircle className="w-12 h-12 mx-auto text-gray-300 mb-3" />
                <p className="text-sm">Ask me anything about this question!</p>
                <p className="text-xs text-gray-400 mt-1">
                  I can explain it in simple terms, give examples, or help you figure out your answer.
                </p>
              </div>
            ) : (
              messages.map((message, index) => (
                <ChatMessage key={index} message={message} />
              ))
            )}

            {/* Loading indicator */}
            {isLoading && (
              <div className="flex gap-3">
                <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                  <span className="text-gray-600 text-xs">AI</span>
                </div>
                <div className="bg-gray-100 px-4 py-2 rounded-2xl rounded-bl-md">
                  <div className="flex gap-1">
                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                    <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
                  </div>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Suggestion button */}
          {latestSuggestion && (
            <div className="px-4 pb-2">
              <SuggestionButton
                fieldId={activeQuestion.fieldId}
                suggestion={latestSuggestion.answer}
                confidence={latestSuggestion.confidence}
              />
            </div>
          )}

          {/* Quick actions */}
          <div className="px-4 pb-2">
            <QuickActions onAction={handleQuickAction} disabled={isLoading} />
          </div>

          {/* Input */}
          <form onSubmit={handleSubmit} className="px-4 pb-4">
            <div className="flex gap-2">
              <input
                ref={inputRef}
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                placeholder="Type your question..."
                disabled={isLoading}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100"
              />
              <button
                type="submit"
                disabled={!inputValue.trim() || isLoading}
                className="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                aria-label="Send message"
              >
                <Send className="w-5 h-5" />
              </button>
            </div>
          </form>
        </div>
      );
    }
    ```
  </action>
  <verify>
    cd frontend && npx tsc --noEmit
  </verify>
  <done>
    ChatPanel renders with question context header, message list, input field, quick actions, loading indicator, and suggestion button
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ChatPanel into main page</name>
  <files>
    frontend/src/app/page.tsx
  </files>
  <action>
    Update frontend/src/app/page.tsx to include ChatPanel and adjust layout:

    ```tsx
    'use client';

    import { Header } from '@/components/Header';
    import { ProgressBar } from '@/components/ProgressBar';
    import { FormSection } from '@/components/FormSection';
    import { ChatPanel } from '@/components/ChatPanel';
    import { ontarioWorksForm } from '@/data/ontarioWorksForm';
    import { useFormStore } from '@/store/formStore';

    export default function Home() {
      const setActiveQuestion = useFormStore((state) => state.setActiveQuestion);
      const activeQuestionId = useFormStore((state) => state.activeQuestionId);

      const handleHelpClick = (questionId: string) => {
        setActiveQuestion(questionId);
      };

      return (
        <div className="min-h-screen bg-gray-50">
          <Header />
          <ProgressBar sections={ontarioWorksForm.sections} />

          <main className={`max-w-4xl mx-auto px-6 py-8 transition-all duration-300 ${activeQuestionId ? 'md:mr-[420px]' : ''}`}>
            <div className="mb-6">
              <h2 className="text-2xl font-bold text-gray-900">{ontarioWorksForm.name}</h2>
              <p className="text-gray-600 mt-1">{ontarioWorksForm.description}</p>
            </div>

            {ontarioWorksForm.sections.map((section, index) => (
              <FormSection
                key={section.id}
                section={section}
                sectionNumber={index + 1}
                onHelpClick={handleHelpClick}
              />
            ))}
          </main>

          <ChatPanel />
        </div>
      );
    }
    ```
  </action>
  <verify>
    cd frontend && npm run build
  </verify>
  <done>
    ChatPanel appears when help button is clicked, main content shifts to make room for panel on desktop
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run dev` - page loads without errors
2. Click help button on any question - chat panel slides in from right
3. Type message and click send - user message appears in chat
4. Message sent to backend API (requires backend running on :5001 with GEMINI_API_KEY)
5. AI response appears with distinct styling from user message
6. Loading dots animate while waiting for response
7. Click quick action button - sends predefined message
8. If AI suggests an answer, suggestion button appears
9. Click suggestion button - form field is auto-filled
10. Close button dismisses chat panel
</verification>

<success_criteria>
- Chat panel shows question context at top
- Message list displays user/assistant messages with distinct styling (blue for user, gray for AI)
- Text input with send button works
- Quick action buttons ("What does this mean?", "Give me an example", "Does my situation apply?") work
- Loading indicator (animated dots) shows during AI response
- AI suggestion displays as clickable button
- Clicking suggestion button auto-fills the form field
- Conversation history is maintained per question (switch questions and switch back)
- Chat panel can be closed with X button
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend-core/02-03-SUMMARY.md`
</output>
